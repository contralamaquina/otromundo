<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Quitar fondo con Replicate API</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #222;
    color: #eee;
    text-align: center;
    padding: 2rem;
  }
  input, button {
    margin: 1rem;
    padding: 0.5rem 1rem;
    font-size: 1.1rem;
    cursor: pointer;
  }
  img {
    max-width: 300px;
    margin-top: 1rem;
    border: 3px solid #0f0;
    border-radius: 8px;
  }
</style>
</head>
<body>

<h1>Quitar fondo con Replicate API</h1>
<input type="file" id="logoInput" accept="image/*" />
<br />
<button id="removeBgBtn">ðŸ§¹ Quitar fondo</button>

<div>
  <h2>Vista previa</h2>
  <img id="cleanLogo" alt="Logo sin fondo" />
</div>

<br />
<button id="downloadBtn" disabled>ðŸ’¾ Descargar logo limpio PNG</button>

<script>
  const apiKey = "r8_67eJcaJIKe7KLdanwqufG28wBbQ2Xmd03Z2fd"; // Tu clave Replicate
  const modelVersion = "7de4b15d1a064d9d8c488d0e2df10baf5c3b6a8e66e46f0d2e9b9e2cc287e735"; // u2net remove bg

  const logoInput = document.getElementById("logoInput");
  const removeBgBtn = document.getElementById("removeBgBtn");
  const cleanLogo = document.getElementById("cleanLogo");
  const downloadBtn = document.getElementById("downloadBtn");

  let selectedFile = null;
  let cleanImageURL = null;

  logoInput.addEventListener("change", (e) => {
    selectedFile = e.target.files[0];
    cleanLogo.src = "";
    downloadBtn.disabled = true;
  });

  async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(",")[1]); // solo base64 sin encabezado
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function pollPrediction(url) {
    while (true) {
      const res = await fetch(url, {
        headers: { Authorization: "Token " + apiKey }
      });
      const data = await res.json();
      if (data.status === "succeeded") return data;
      if (data.status === "failed") throw new Error("La predicciÃ³n fallÃ³");
      await new Promise(r => setTimeout(r, 1000));
    }
  }

  removeBgBtn.addEventListener("click", async () => {
    if (!selectedFile) {
      alert("Primero cargÃ¡ un logo.");
      return;
    }
    removeBgBtn.disabled = true;
    removeBgBtn.textContent = "Procesando...";

    try {
      const base64Img = await fileToBase64(selectedFile);

      const res = await fetch("https://api.replicate.com/v1/predictions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Token " + apiKey
        },
        body: JSON.stringify({
          version: modelVersion,
          input: { image: "data:image/png;base64," + base64Img }
        })
      });

      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(errorText);
      }

      const prediction = await res.json();
      const result = await pollPrediction(prediction.urls.get);

      if (cleanImageURL) URL.revokeObjectURL(cleanImageURL);
      cleanImageURL = result.output;
      cleanLogo.src = cleanImageURL;
      downloadBtn.disabled = false;

    } catch (e) {
      alert("Error: " + e.message);
    }

    removeBgBtn.disabled = false;
    removeBgBtn.textContent = "ðŸ§¹ Quitar fondo";
  });

  downloadBtn.addEventListener("click", () => {
    if (!cleanImageURL) return;
    // El output de replicate ya es URL directa
    const link = document.createElement("a");
    link.href = cleanImageURL;
    link.download = "logo-sin-fondo.png";
    link.click();
  });
</script>

</body>
</html>
