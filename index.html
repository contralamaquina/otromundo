<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Quitar fondo con CORS Anywhere y Replicate API</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: 'Courier New', monospace;
    text-align: center;
    padding: 2rem;
  }
  input, button {
    margin: 1rem;
    padding: 0.7rem 1.2rem;
    font-size: 1.1rem;
    cursor: pointer;
    border-radius: 6px;
    border: none;
  }
  button {
    background: #f03a3a;
    color: white;
  }
  img {
    margin-top: 1rem;
    max-width: 300px;
    border: 2px solid #0f0;
    border-radius: 8px;
  }
</style>
</head>
<body>

<h1>Quitar fondo con CORS Anywhere y Replicate API</h1>
<input type="file" id="fileInput" accept="image/*" />
<br />
<button id="btnRemoveBg">🧹 Quitar fondo</button>

<div>
  <h2>Resultado</h2>
  <img id="resultImg" alt="Logo sin fondo" />
</div>

<script>
  const fileInput = document.getElementById('fileInput');
  const btnRemoveBg = document.getElementById('btnRemoveBg');
  const resultImg = document.getElementById('resultImg');

  // Cambiá por tu API Key de Replicate
  const API_KEY = "r8_LXxyHy8ThawFp2Qn0uf67ujKjxZr8zO3ooxNH";
  const MODEL_VERSION = "7de4b15d1a064d9d8c488d0e2df10baf5c3b6a8e66e46f0d2e9b9e2cc287e735";

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function removeBackground(base64Image) {
    const proxyUrl = "https://cors-anywhere.herokuapp.com/";
    const apiUrl = "https://api.replicate.com/v1/predictions";

    // Crear la predicción
    const response = await fetch(proxyUrl + apiUrl, {
      method: "POST",
      headers: {
        Authorization: "Token " + API_KEY,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        version: MODEL_VERSION,
        input: { image: "data:image/png;base64," + base64Image },
      }),
    });

    if (!response.ok) {
      const err = await response.text();
      throw new Error("Error al crear predicción: " + err);
    }

    const prediction = await response.json();

    // Polling hasta que la predicción esté lista
    while (true) {
      const statusRes = await fetch(proxyUrl + prediction.urls.get, {
        headers: { Authorization: "Token " + API_KEY },
      });
      const statusData = await statusRes.json();

      if (statusData.status === "succeeded") return statusData.output;
      if (statusData.status === "failed") throw new Error("La predicción falló");

      await new Promise(r => setTimeout(r, 1000));
    }
  }

  btnRemoveBg.addEventListener('click', async () => {
    if (!fileInput.files.length) {
      alert("Primero subí una imagen");
      return;
    }
    btnRemoveBg.disabled = true;
    btnRemoveBg.textContent = "Procesando...";

    try {
      const base64Img = await fileToBase64(fileInput.files[0]);
      const outputUrls = await removeBackground(base64Img);

      // outputUrls es un array con URLs, mostramos la primera
      resultImg.src = outputUrls[0];
    } catch (e) {
      alert("Error: " + e.message);
    }

    btnRemoveBg.disabled = false;
    btnRemoveBg.textContent = "🧹 Quitar fondo";
  });
</script>

</body>
</html>
